<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CE Automation - Command Reference</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        h1 {
            text-align: center;
            border-bottom-width: 3px;
        }
        h2 {
            margin-top: 40px;
        }
        hr {
            border: 0;
            height: 1px;
            background-color: #dee2e6;
            margin: 40px 0;
        }
        code {
            background-color: #e8e8e8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        strong {
            color: #34495e;
        }
        .note {
            background-color: #e7f3ff;
            border-left: 5px solid #0d6efd;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CE Automation - Workflow Command Reference</h1>
        <p>This document provides a complete reference for all commands and functions available for use in your <code>workflows.yaml</code> files.</p>

        <hr>

        <h2>I. Action Commands</h2>
        <p>These are the primary commands that perform an action within the emulator.</p>

        <h3><code>click</code></h3>
        <p>Simulates a tap on the screen at a specific coordinate.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>click: [x, y]</code></li>
        </ul>

        <h3><code>scroll</code></h3>
        <p>Simulates a swipe gesture on the screen from a starting point.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>scroll: [x, y, direction, distance]</code></li>
            <li><strong>Parameters:</strong> <code>direction</code> must be <code>up</code>, <code>down</code>, <code>left</code>, or <code>right</code>.</li>
        </ul>

        <h3><code>delay</code></h3>
        <p>Pauses the execution of the script for a specified number of seconds.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>delay: seconds</code></li>
        </ul>

        <h3><code>log</code></h3>
        <p>Prints a message to the console and the log file for debugging and progress tracking.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>log: "Your message here"</code></li>
        </ul>

        <h3><code>send_email</code></h3>
        <p>Sends an email notification using the configured Outlook account.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>send_email: "Your message here"</code></li>
        </ul>
        
        <h3><code>emergency_exit</code></h3>
        <p>Immediately stops the entire automation script and sends a critical error email. Use this for unrecoverable errors.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>emergency_exit: "Error message"</code></li>
        </ul>

        <hr>

        <h2>II. Variable & Context Commands</h2>
        <p>These commands allow you to store and manipulate internal variables (the "context") within a scenario.</p>

        <h3><code>set</code></h3>
        <p>Creates or overwrites a variable in the scenario's context.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>set: { variable_name: value }</code></li>
            <li><strong>Example:</strong>
<pre><code>- set: { click_attempts: 0 } # Initialize a loop counter</code></pre>
            </li>
        </ul>

        <h3><code>increment</code></h3>
        <p>Adds 1 to a numeric variable. If the variable doesn't exist, it is created with a value of 1.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>increment: variable_name</code></li>
            <li><strong>Example:</strong>
<pre><code>- increment: click_attempts # Increases the value of 'click_attempts' by 1</code></pre>
            </li>
        </ul>

        <hr>

        <h2>III. Control Flow Commands</h2>
        <p>These commands control the logic of your scenario, allowing for conditional execution and loops.</p>

        <h3><code>if / else</code></h3>
        <p>Executes a block of steps only if a condition is met.</p>
<pre><code>- if:
    condition: "your_condition_here"
    then:
      # ... steps to run if condition is true ...
    else:
      # ... (optional) steps to run if condition is false ...</code></pre>

        <h3><code>while</code></h3>
        <p>Repeatedly executes a block of steps as long as a condition remains true.</p>
<pre><code>- while:
    condition: "your_condition_here"
    do:
      # ... steps to repeat while the condition is true ...</code></pre>
        
        <hr>

        <h2>IV. Dynamic Actions & Templating</h2>
        <p>The real power of the engine comes from using variables and functions to make your actions dynamic. This is done using the Jinja2 templating syntax: <code>{{ ... }}</code>.</p>
        
        <div class="note">
            <strong>The Golden Rule:</strong> To use a variable or perform a calculation as a parameter for an action, you <strong>must</strong> wrap it in quotes and curly braces: <code>"{{ your_variable }}"</code> or <code>"{{ your_variable[0] + 10 }}"</code>.
        </div>
        
        <h3>Dynamic <code>set</code></h3>
        <p>Store the result of a function call in a variable.</p>
        <pre><code># Find the 'Home' button and store its coordinates in the 'home_button_coords' variable
- set:
    home_button_coords: "{{ get_coords_from_image('home_button.png') }}"</code></pre>
    
        <h3>Dynamic <code>click</code> and <code>scroll</code></h3>
        <p>Use variables to define where to click or scroll. This is the key to creating robust, anchor-based automation.</p>
        <pre><code># Click the coordinates stored in the 'home_button_coords' variable
- click: "{{ home_button_coords }}"

# Click 50 pixels to the right of the found button
- click: [ "{{ home_button_coords[0] + 50 }}", "{{ home_button_coords[1] }}" ]

# Scroll up, starting from the position of the found button
- scroll: [ "{{ home_button_coords[0] }}", "{{ home_button_coords[1] }}", "up", 400 ]</code></pre>

        <hr>

        <h2>V. Functions</h2>
        <p>These functions can be used within the <code>{{ ... }}</code> templating syntax, typically with the <code>set</code> command, or inside the <code>condition:</code> string of an <code>if</code> or <code>while</code> block.</p>
        
        <h3><code>get_coords_from_image</code></h3>
        <p>Finds the <strong>single best match</strong> for a template image on the screen and returns its center coordinates as a tuple `(x, y)`. Returns `None` if no match is found.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>get_coords_from_image('image.png', threshold)</code></li>
            <li><strong>Example:</strong>
<pre><code># Find the 'Confirm' button and store its location
- set:
    confirm_coords: "{{ get_coords_from_image('button_confirm.png', threshold=0.9) }}"
- if:
    condition: "confirm_coords"
    then:
      - click: "{{ confirm_coords }}"</code></pre>
            </li>
        </ul>
        
        <h3><code>get_all_coords_from_image</code></h3>
        <p>Finds <strong>all occurrences</strong> of a template image on the screen and returns a list of coordinate tuples `[(x1, y1), (x2, y2), ...]`. The list is sorted from top-to-bottom, left-to-right. Returns an empty list `[]` if no matches are found.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>get_all_coords_from_image('image.png', threshold)</code></li>
            <li><strong>Example (Clicking the lowest button):</strong>
<pre><code># Find all 'Claim' buttons
- set:
    all_buttons: "{{ get_all_coords_from_image('claim_button.png', threshold=0.9) }}"

# Check if any buttons were found
- if:
    condition: "all_buttons" # True if the list is not empty
    then:
      # The list is sorted top-to-bottom, so the last item [-1] is the lowest on screen
      - log: "Found {{ len(all_buttons) }} buttons. Clicking the lowest one."
      - click: "{{ all_buttons[-1] }}"</code></pre>
            </li>
        </ul>

        <h3><code>compare_with_image</code></h3>
        <p>Returns <code>True</code> or <code>False</code>. Best used inside a condition to quickly check if an image exists in a specific region.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>compare_with_image(x, y, w, h, 'image.png', threshold)</code></li>
            <li><strong>Example:</strong>
<pre><code>condition: "compare_with_image(20, 20, 100, 100, 'back-arrow.png')"</code></pre>
            </li>
        </ul>
        
        <h3><code>compare_with_any_image</code></h3>
        <p>Returns <code>True</code> if <strong>any one</strong> of a list of images is found in a region.</p>
        <ul>
            <li><strong>Syntax:</strong> <code>compare_with_any_image(x, y, w, h, ['img1.png', 'img2.png'])</code></li>
            <div class="warning">
                <strong>Important:</strong> Because this function's syntax uses square brackets <code>[]</code>, you <strong>must</strong> wrap the entire condition in double quotes <code>"..."</code> to avoid a YAML parsing error.
            </div>
            <li><strong>Example:</strong>
<pre><code>condition: "compare_with_any_image(300, 400, 50, 50, ['gold_chest.png', 'purple_chest.png'])"</code></pre>
            </li>
        </ul>

        <h3><code>compare_with_text</code> / <code>compare_with_text_easyocr</code></h3>
        <p>Returns <code>True</code> if the expected text is found within a region of the screen (case-insensitive).</p>
        <ul>
            <li><strong>Syntax:</strong> <code>compare_with_text(x, y, w, h, 'expected text')</code></li>
            <li><strong>Example:</strong>
<pre><code>condition: "compare_with_text(297, 565, 156, 34, 'Claim All')"</code></pre>
            </li>
        </ul>

        <h3>Combining Conditions</h3>
        <p>You can combine conditions using standard logical operators: <code>and</code>, <code>or</code>, and <code>not</code>.</p>
<pre><code>condition: "not compare_with_image(100,100,50,50,'error.png') and click_attempts < 5"</code></pre>
        
        <hr>

        <h2>VI. Best Practices & Tips</h2>
        <ul>
            <li><strong>Anchor-Based Automation is Best:</strong> Avoid hardcoded coordinates like <code>click: [100, 200]</code> whenever possible. Use <code>get_coords_from_image</code> to find an element first, then use the returned variable to click. This makes your scripts resilient to ads and UI shifts.</li>
            <li><strong>Use the Tester:</strong> Use <code>ce_tester.py</code> to test your anchor images. Option <code>9</code> (Get Coordinates from Image) is perfect for checking if your image is unique and detectable.</li>
            <li><strong>Quote Your Conditions:</strong> When in doubt, always wrap your entire <code>condition:</code> string in double quotes <code>"..."</code> to prevent issues with special characters.</li>
            <li><strong>Add Delays:</strong> After a click that triggers a screen transition or animation, add a <code>delay</code> to give the game time to load before you look for the next element.</li>
            <li><strong>Indentation is Key:</strong> YAML relies on strict indentation. All steps in a block (<code>steps:</code>, <code>then:</code>, <code>do:</code>) must be indented and start with a <code>-</code>.</li>
        </ul>
    </div>
</body>
</html>