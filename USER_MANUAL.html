<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CE Automation - User Manual & Command Reference</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        h1 {
            text-align: center;
            border-bottom-width: 3px;
        }
        h2 {
            margin-top: 40px;
        }
        h3 {
            margin-top: 30px;
            border-bottom-width: 1px;
        }
        h4 {
            border-bottom-style: none;
            margin-top: 20px;
        }
        hr {
            border: 0;
            height: 1px;
            background-color: #dee2e6;
            margin: 40px 0;
        }
        code {
            background-color: #e8e8e8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        strong {
            color: #34495e;
        }
        .note {
            background-color: #e7f3ff;
            border-left: 5px solid #0d6efd;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CE Automation - User Manual & Command Reference</h1>
        <p>This document provides a complete guide for configuring and writing automation workflows for the CE Automation script.</p>

        <hr>

        <h2>I. Running the Robot</h2>
        <p>You can run the main script, <code>ce_robot.py</code>, in several ways from your command line. Open a terminal, navigate to the project directory, and use one of the following commands.</p>

        <h3>Standard Mode</h3>
        <p>Runs the script according to the settings in <code>instances.ini</code>, using the <code>[RunOrder]</code> and <code>[Workflows]</code> sections.</p>
        <pre><code>python ce_robot.py</code></pre>

        <h3>Targeted Instance(s) Mode</h3>
        <p>Runs the script for one or more specific instances, ignoring the <code>[RunOrder]</code> section.</p>
        <pre><code># Run only for the 'Adidas' instance
python ce_robot.py Adidas

# Run for 'Adidas' and 'CE_2024_1' in that order
python ce_robot.py Adidas CE_2024_1</code></pre>

        <h3>Custom Workflow File Mode</h3>
        <p>Uses a specific YAML file for the run instead of the default. This is perfect for testing or running special, one-off tasks. The path should be relative to the script's location.</p>
        <pre><code># Use a special workflow file for the standard run order
python ce_robot.py -wf "resources/en/special_tasks.yaml"

# Combine with targeted instances
python ce_robot.py Adidas -wf "resources/en/test_expedition.yaml"</code></pre>

        <hr>

        <h2>II. Core Concepts & Configuration</h2>
        
        <h3>The Workflow File</h3>
        <p>All automation logic is written in YAML files (e.g., <code>workflows.yaml</code>). A file contains one or more <strong>scenarios</strong>. A scenario is a named sequence of <strong>steps</strong> that the robot executes in order.</p>

        <h3>Centralized Workflows in <code>instances.ini</code></h3>
        <p>To avoid duplicating workflow lists for every instance, you can define them centrally in <code>instances.ini</code>.</p>
        <ol>
            <li><strong>Remove</strong> the <code>workflows = ...</code> line from your individual instance sections (e.g., <code>[Adidas]</code>).</li>
            <li><strong>Add a <code>[Workflows]</code> section</strong> to define named sets of tasks (e.g., `daily_tasks`).</li>
            <li><strong>Add an <code>active_set</code> key</strong> to your <code>[RunOrder]</code> section to choose which set to run.</li>
        </ol>
        <pre><code>[Workflows]
daily_tasks = Daily_rewards, Campaign_farming, Guild_activity
weekend_event = Weekend_Boss_Event, Special_Arena

[RunOrder]
order = Adidas, CE_2024_1
active_set = daily_tasks</code></pre>

        <h3>Anchor-Based Automation</h3>
        <p>This is the most important concept for creating reliable scripts. Instead of using fixed, hardcoded coordinates that can break when ads appear or the UI shifts, you should find a visual "anchor" on the screen first, and then perform actions relative to it.</p>
        <pre><code># The Brittle Way (Avoid This)
- click: [850, 690] # Fails if the Guild button moves

# The Robust Way (Use This)
- set:
    guild_button_coords: "{{ get_coords_from_image('guild_button.png') }}"
- if:
    condition: "guild_button_coords"
    then:
      - click: "{{ guild_button_coords }}"</code></pre>

        <hr>

        <h2>III. YAML Workflow Commands</h2>
        
        <h3>Action Commands</h3>
        <p>These commands perform a direct action in the emulator.</p>

        <h4><code>click</code></h4>
        <p>Simulates a tap on the screen.</p>
        <pre><code># Click a static, hardcoded coordinate
- click: [100, 250]</code></pre>

        <h4><code>scroll</code></h4>
        <p>Simulates a swipe gesture.</p>
        <pre><code># Scroll up from the middle of the screen by 400 pixels
- scroll: [540, 700, "up", 400]</code></pre>

        <h4><code>delay</code></h4>
        <p>Pauses the script. Essential for waiting for screens to load.</p>
        <pre><code># Wait 3.5 seconds for an animation to finish
- delay: 3.5</code></pre>
        
        <h4><code>log</code></h4>
        <p>Prints a message to the console and log file.</p>
        <pre><code># Log the current progress
- log: "Starting attack #{{ attempt_counter }} in the Arena."</code></pre>
        
        <h4><code>send_email</code></h4>
        <p>Sends a notification email to the address in <code>instances.ini</code>.</p>
        <pre><code># Send a notification that a rare event has started
- send_email: "The 'Galactic Conquest' event is now active!"</code></pre>

        <h4><code>emergency_exit</code></h4>
        <p>Immediately stops the entire program. Use for unrecoverable errors.</p>
        <pre><code># Stop the script if a critical element is not found
- emergency_exit: "Could not find the 'Home' button. State is unrecoverable."</code></pre>

        <h3>Variable & Context Commands</h3>
        <p>These commands manage the script's internal memory (context).</p>

        <h4><code>set</code></h4>
        <p>Creates or updates a variable.</p>
        <pre><code># Initialize a counter variable to 0
- set:
    attack_counter: 0</code></pre>

        <h4><code>increment</code></h4>
        <p>Adds 1 to a numeric variable.</p>
        <pre><code># Increment the counter after an attack
- increment: attack_counter</code></pre>
        
        <h3>Control Flow Commands</h3>
        <p>These commands control the script's logic.</p>

        <h4><code>if / then / else</code></h4>
        <p>Executes steps conditionally.</p>
        <pre><code>- if:
    condition: "attack_counter < 5"
    then:
      - log: "Still have attacks left. Continuing."
    else:
      - log: "No attacks left. Exiting Arena."</code></pre>
        
        <h4><code>while / do</code></h4>
        <p>Executes steps in a loop as long as a condition is true.</p>
        <pre><code>- while:
    condition: "get_coords_from_image('claim_reward.png')"
    do:
      - log: "Found a reward to claim. Clicking it."
      - click: "{{ get_coords_from_image('claim_reward.png') }}"
      - delay: 2</code></pre>
        
        <hr>

        <h2>IV. Functions for Finding & Comparing</h2>
        <p>These functions are the "eyes" of the robot. They can be used with <code>set</code> to store a result, or directly inside a <code>condition</code> string.</p>
        
        <h3>Static Object Detection (Template Matching)</h3>
        <p>Fast and precise. Use for UI elements that are static (not animated).</p>
        
        <h4><code>get_coords_from_image('image.png', threshold)</code></h4>
        <p>Finds the <strong>single best match</strong> for a static image and returns its center coordinates `(x, y)`.</p>

        <h4><code>get_all_coords_from_image('image.png', threshold)</code></h4>
        <p>Finds <strong>all occurrences</strong> of a static image and returns a <strong>sorted list</strong> of coordinates `[(x1, y1), ...]`, from top-to-bottom, left-to-right.</p>
        <div class="note">
            <h4>Targeting Specific Occurrences</h4>
            <p>Because the returned list is sorted, you can reliably target specific items:</p>
            <ul>
                <li><strong>Topmost Item:</strong> Use index <code>[0]</code>.</li>
                <li><strong>Bottommost Item:</strong> Use index <code>[-1]</code>.</li>
            </ul>
            <pre><code># Find all 'Claim' buttons and click the one lowest on the screen
- set:
    all_buttons: "{{ get_all_coords_from_image('claim_button.png') }}"
- if:
    condition: "all_buttons"
    then:
      - log: "Clicking the lowest of {{ len(all_buttons) }} buttons."
      - click: "{{ all_buttons[-1] }}"</code></pre>
        </div>
        
        <h3>Animated/Dynamic Object Detection (Feature Matching)</h3>
        <p>More robust. Use for elements that are animated, scaled, or rotated.</p>
        
        <h4><code>get_coords_from_features('image.png', min_match_count)</code></h4>
        <p>Finds the <strong>single best match</strong> for a dynamic/animated image and returns its center coordinates `(x, y)`.</p>

        <h4><code>get_all_coords_from_features(...)</code></h4>
        <p>Finds <strong>all occurrences</strong> of a dynamic/animated image and returns a sorted list of coordinates.</p>
        <ul><li><strong>Syntax:</strong> <code>get_all_coords_from_features('image.png', min_match_count, eps, min_samples)</code></li></ul>
        <div class="note">
            <h4>Targeting Specific Occurrences</h4>
            <p>This function also returns a sorted list, so the same targeting logic applies:</p>
            <pre><code># Find all animated cards and click the topmost one
- set:
    all_cards: "{{ get_all_coords_from_features('animated_card.png') }}"
- if:
    condition: "all_cards"
    then:
      - log: "Clicking the topmost of {{ len(all_cards) }} cards."
      - click: "{{ all_cards[0] }}"</code></pre>
        </div>
        <div class="warning">
            <h4>Tuning Feature Detection</h4>
            <p>Feature-based functions require tuning. Use <code>ce_tester.py</code> to experiment.</p>
            <ul>
                <li><code>min_match_count</code>: Minimum good feature matches required. Lower for small/simple images; raise to avoid false positives.</li>
                <li><code>eps</code>: Max pixel distance for points to be in the same object. A good start is half the template's width/height.</li>
                <li><code>min_samples</code>: Min features needed to form a valid object cluster. Lower for small objects.</li>
            </ul>
        </div>
        
        <h3>Text and Other Comparisons</h3>
        <p>These functions are for use inside a <code>condition:</code> string and return <code>True/False</code>.</p>
        <ul>
            <li><code>compare_with_image(x, y, w, h, 'image.png', threshold)</code></li>
            <li><code>compare_with_any_image(x, y, w, h, ['img1.png', 'img2.png'])</code></li>
            <li><code>compare_with_text(x, y, w, h, 'expected text')</code></li>
        </ul>
    </div>
</body>
</html>