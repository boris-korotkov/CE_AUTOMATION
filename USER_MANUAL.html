<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CE Automation - Command Reference</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        h1 {
            text-align: center;
            border-bottom-width: 3px;
        }
        h2 {
            margin-top: 40px;
        }
        h3 {
            margin-top: 30px;
            border-bottom-width: 1px;
        }
        h4 {
            border-bottom-style: none;
            margin-top: 20px;
        }
        hr {
            border: 0;
            height: 1px;
            background-color: #dee2e6;
            margin: 40px 0;
        }
        code {
            background-color: #e8e8e8;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        strong {
            color: #34495e;
        }
        .note {
            background-color: #e7f3ff;
            border-left: 5px solid #0d6efd;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CE Automation - Workflow Command Reference</h1>
        <p>This document provides a complete reference for all commands and functions available for use in your <code>workflows.yaml</code> files.</p>

        <hr>

        <h2>I. Action Commands</h2>
        <!-- Unchanged Section -->
        <h3><code>click</code></h3><p>Simulates a tap on the screen at a specific coordinate.</p><ul><li><strong>Syntax:</strong> <code>click: [x, y]</code></li></ul>
        <h3><code>scroll</code></h3><p>Simulates a swipe gesture on the screen from a starting point.</p><ul><li><strong>Syntax:</strong> <code>scroll: [x, y, direction, distance]</code></li><li><strong>Parameters:</strong> <code>direction</code> must be <code>up</code>, <code>down</code>, <code>left</code>, or <code>right</code>.</li></ul>
        <h3><code>delay</code></h3><p>Pauses the execution of the script for a specified number of seconds.</p><ul><li><strong>Syntax:</strong> <code>delay: seconds</code></li></ul>
        <h3><code>log</code></h3><p>Prints a message to the console and the log file for debugging and progress tracking.</p><ul><li><strong>Syntax:</strong> <code>log: "Your message here"</code></li></ul>
        <h3><code>send_email</code></h3><p>Sends an email notification using the configured Outlook account.</p><ul><li><strong>Syntax:</strong> <code>send_email: "Your message here"</code></li></ul>
        <h3><code>emergency_exit</code></h3><p>Immediately stops the entire automation script and sends a critical error email. Use this for unrecoverable errors.</p><ul><li><strong>Syntax:</strong> <code>emergency_exit: "Error message"</code></li></ul>
        <hr>

        <h2>II. Variable & Context Commands</h2>
        <!-- Unchanged Section -->
        <h3><code>set</code></h3><p>Creates or overwrites a variable in the scenario's context.</p><ul><li><strong>Syntax:</strong> <code>set: { variable_name: value }</code></li><li><strong>Example:</strong> <pre><code>- set: { click_attempts: 0 } # Initialize a loop counter</code></pre></li></ul>
        <h3><code>increment</code></h3><p>Adds 1 to a numeric variable. If the variable doesn't exist, it is created with a value of 1.</p><ul><li><strong>Syntax:</strong> <code>increment: variable_name</code></li><li><strong>Example:</strong> <pre><code>- increment: click_attempts # Increases the value of 'click_attempts' by 1</code></pre></li></ul>
        <hr>
        
        <h2>III. Control Flow Commands</h2>
        <!-- Unchanged Section -->
        <h3><code>if / else</code></h3><p>Executes a block of steps only if a condition is met.</p><pre><code>- if:
    condition: "your_condition_here"
    then:
      # ... steps to run if condition is true ...
    else:
      # ... (optional) steps to run if condition is false ...</code></pre>
        <h3><code>while</code></h3><p>Repeatedly executes a block of steps as long as a condition remains true.</p><pre><code>- while:
    condition: "your_condition_here"
    do:
      # ... steps to repeat while the condition is true ...</code></pre>
        <hr>

        <h2>IV. Dynamic Actions & Templating</h2>
        <p>The real power of the engine comes from using variables and functions to make your actions dynamic. This is done using the Jinja2 templating syntax: <code>{{ ... }}</code>.</p>
        <div class="note"><strong>The Golden Rule:</strong> To use a variable or perform a calculation as a parameter for an action, you <strong>must</strong> wrap it in quotes and curly braces: <code>"{{ your_variable }}"</code> or <code>"{{ your_variable[0] + 10 }}"</code>.</div>
        <h3>Dynamic <code>set</code></h3><p>Store the result of a function call in a variable.</p><pre><code># Find the 'Home' button and store its coordinates in the 'home_button_coords' variable
- set:
    home_button_coords: "{{ get_coords_from_image('home_button.png') }}"</code></pre>
        <h3>Dynamic <code>click</code> and <code>scroll</code></h3><p>Use variables to define where to click or scroll. This is the key to creating robust, anchor-based automation.</p><pre><code># Click the coordinates stored in the 'home_button_coords' variable
- click: "{{ home_button_coords }}"

# Click 50 pixels to the right of the found button
- click: [ "{{ home_button_coords[0] + 50 }}", "{{ home_button_coords[1] }}" ]</code></pre>
        <h3>Using Functions in Templates</h3><p>You can use certain built-in functions like <code>len()</code> to inspect variables directly in your templates.</p><pre><code># Log how many buttons were found
- log: "Found {{ len(all_buttons) }} buttons on the screen."</code></pre>
        <hr>

        <h2>V. Functions for Finding & Comparing</h2>
        <p>These functions can be used within the <code>{{ ... }}</code> templating syntax, typically with the <code>set</code> command, or inside the <code>condition:</code> string of an <code>if</code> or <code>while</code> block.</p>
        
        <h3>Static Object Detection (Template Matching)</h3>
        <p>These functions are fast and precise. Use them for UI elements that are static (not animated, scaled, or rotated).</p>
        
        <h4><code>get_coords_from_image</code></h4>
        <p>Finds the <strong>single best match</strong> for a static image and returns its center coordinates `(x, y)`.</p>
        <ul><li><strong>Syntax:</strong> <code>get_coords_from_image('image.png', threshold)</code></li></ul>

        <h4><code>get_all_coords_from_image</code></h4>
        <p>Finds <strong>all occurrences</strong> of a static image and returns a <strong>sorted list</strong> of coordinates `[(x1, y1), ...]`. The list is sorted from top-to-bottom, then left-to-right.</p>
        <ul><li><strong>Syntax:</strong> <code>get_all_coords_from_image('image.png', threshold)</code></li></ul>
        <div class="note">
            <h4>Targeting Specific Occurrences</h4>
            <p>Because the returned list is sorted, you can reliably target specific items:</p>
            <ul>
                <li><strong>Topmost Item:</strong> Use index <code>[0]</code>.</li>
                <li><strong>Bottommost Item:</strong> Use index <code>[-1]</code>.</li>
            </ul>
            <pre><code># Find all 'Claim' buttons and click the one lowest on the screen
- set:
    all_buttons: "{{ get_all_coords_from_image('claim_button.png') }}"
- if:
    condition: "all_buttons"
    then:
      - log: "Clicking the lowest of {{ len(all_buttons) }} buttons."
      - click: "{{ all_buttons[-1] }}"</code></pre>
        </div>

        <h4><code>compare_with_image</code></h4>
        <p>Returns <code>True/False</code> if a static image exists in a specific region.</p>
        <ul><li><strong>Syntax:</strong> <code>compare_with_image(x, y, w, h, 'image.png', threshold)</code></li></ul>

        <h3>Animated/Dynamic Object Detection (Feature Matching)</h3>
        <p>These functions are more robust and should be used for elements that are animated, slightly scaled, rotated, or have inconsistent appearances.</p>
        
        <h4><code>get_coords_from_features</code></h4>
        <p>Finds the <strong>single best match</strong> for a dynamic/animated image and returns its center coordinates `(x, y)`.</p>
        <ul><li><strong>Syntax:</strong> <code>get_coords_from_features('image.png', min_match_count)</code></li></ul>

        <h4><code>get_all_coords_from_features</code></h4>
        <p>Finds <strong>all occurrences</strong> of a dynamic/animated image and returns a <strong>sorted list</strong> of coordinates `[(x1, y1), ...]`.</p>
        <ul><li><strong>Syntax:</strong> <code>get_all_coords_from_features('image.png', min_match_count, eps, min_samples)</code></li></ul>
        <div class="note">
            <h4>Targeting Specific Occurrences</h4>
            <p>This function also returns a sorted list, so the same targeting logic applies:</p>
            <pre><code># Find all animated cards and click the topmost one
- set:
    all_cards: "{{ get_all_coords_from_features('animated_card.png') }}"
- if:
    condition: "all_cards"
    then:
      - log: "Clicking the topmost of {{ len(all_cards) }} cards."
      - click: "{{ all_cards[0] }}"</code></pre>
        </div>
        <div class="warning">
            <h4>Tuning Feature Detection</h4>
            <p>Feature-based functions require tuning to work reliably. Use <code>ce_tester.py</code> to experiment with these parameters.</p>
            <ul>
                <li><code>min_match_count</code>: Minimum "good" feature matches required. Lower it (e.g., to 7) for small images; raise it (e.g., to 15) to avoid false positives.</li>
                <li><code>eps</code> (for <code>get_all_coords...</code>): Max pixel distance for points to be in the same object cluster. A good start is half the template's width/height. Increase if one object is detected as many; decrease if many objects are detected as one.</li>
                <li><code>min_samples</code> (for <code>get_all_coords...</code>): Min features needed to form a cluster. Lower it (e.g., to 3) if small objects aren't detected.</li>
            </ul>
        </div>
        
        <h3>Text and Other Comparisons</h3>
        <h4><code>compare_with_any_image</code></h4>
        <p>Returns <code>True</code> if <strong>any one</strong> of a list of static images is found in a region.</p>
        <ul><li><strong>Syntax:</strong> <code>compare_with_any_image(x, y, w, h, ['img1.png', 'img2.png'])</code></li></ul>
        
        <h4><code>compare_with_text</code> / <code>compare_with_text_easyocr</code></h4>
        <p>Returns <code>True</code> if the expected text is found within a region of the screen (case-insensitive).</p>
        <ul><li><strong>Syntax:</strong> <code>compare_with_text(x, y, w, h, 'expected text')</code></li></ul>
        
        <hr>

        <h2>VI. Best Practices & Tips</h2>
        <ul>
            <li><strong>Anchor-Based Automation is Best:</strong> Avoid hardcoded coordinates like <code>click: [100, 200]</code>. Use a <code>get_coords_...</code> function to find an element first, then use the returned variable to click. This makes your scripts resilient to ads and UI shifts.</li>
            <li><strong>Use the Right Tool for the Job:</strong> Use template matching (<code>..._image</code>) for static UI elements (it's faster). Use feature matching (<code>..._features</code>) for anything that moves, scales, or changes appearance.</li>
            <li><strong>Use the Tester:</strong> Use <code>ce_tester.py</code> to test your anchor images and tune your feature detection parameters before writing a complex workflow.</li>
            <li><strong>Quote Your Conditions:</strong> When in doubt, always wrap your entire <code>condition:</code> string in double quotes <code>"..."</code> to prevent issues with special characters, especially if they contain <code>[</code> or <code>]</code>.</li>
            <li><strong>Add Delays:</strong> After a click that triggers a screen transition or animation, add a <code>delay</code> to give the game time to load before you look for the next element.</li>
            <li><strong>Indentation is Key:</strong> YAML relies on strict indentation. All steps in a block (<code>steps:</code>, <code>then:</code>, <code>do:</code>) must be indented and start with a <code>-</code>.</li>
        </ul>
    </div>
</body>
</html>