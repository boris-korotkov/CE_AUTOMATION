scenarios:
  - name: Expedition1_farming_new
    description: Expedition1 farming - optimized
    steps:
      - set:
          guild_coords: "{{ get_coords_from_image('Guild.png') }}"
      - if:
          condition: "guild_coords"  # This is true if coordinates were found, false
          then:
            - scroll: [150,400, right,400] # Scroll left to make sure Expedition icon is visible
            - scroll: [150,400, right,400] # Scroll left to make sure Expedition icon is visible
            - scroll: [150,400, right,400] # Scroll left to make sure Expedition icon is visible
            - scroll: [150,400, right,400] # Scroll left to make sure Expedition icon is visible
            - set:
                expedition_icon_coords: "{{ get_coords_from_image('expedition.png') }}"
            - if:
                condition: "expedition_icon_coords"  # This is true if coordinates were found
                then:
                  - log: "Expedition icon coordinates found"
                  - click: [ "{{ expedition_icon_coords[0]}}", "{{ expedition_icon_coords[1]-100 }}" ] # Click on the Expedition icon
                  - delay: 3
                  - log : "Checking if Expedition 1 farming is available"
                  - set:
                      expedition1_icon_coords: "{{ get_coords_from_image('remote_road.png') }}"
                  - if:
                      condition: "expedition1_icon_coords"  # If Expedition1 farming is available
                      then:
                        - log: "Expedition1 icon coordinates found"
                        - click: [ "{{ expedition1_icon_coords[0]}}", "{{ expedition1_icon_coords[1]+200 }}" ] # Click on the Expedition1 icon
                        - delay: 3
                        - set:
                            free_refresh_button_coords: "{{ get_coords_from_image('free_refresh.png') }}"
                        - if:
                            condition: "free_refresh_button_coords"  # If free_refresh button is available
                            then:
                              - log: "free_refresh button coordinates found"
                              - click: "{{ free_refresh_button_coords }}" # Click on the free_refresh button
                              - delay: 3
                              - set:
                                  confirm_button_coords: "{{ get_coords_from_image('confirm_purple.png') }}"
                              - if:
                                  condition: "confirm_button_coords"  # If Confirm button is available
                                  then:
                                    - log: "Confirm button coordinates found"
                                    - click: "{{ confirm_button_coords }}" # Click on the Confirm button
                                    - delay: 2
                                    - set:
                                        expedition_coin_coords: "{{ get_coords_from_image('expedition_coin.png') }}" # expedition coin coordinates on the top
                                    - set:
                                        expedition_points_data:
                                          - { name: "Point 1", click: [ "{{ expedition_coin_coords[0]}}",    "{{ expedition_coin_coords[1]+200 }}" ], chest: [ "{{ expedition_coin_coords[0]+110}}", "{{ expedition_coin_coords[1]+200 }}" ] }
                                          - { name: "Point 2", click: [ "{{ expedition_coin_coords[0]+290}}", "{{ expedition_coin_coords[1]+430 }}" ], chest: [ "{{ expedition_coin_coords[0]+300}}", "{{ expedition_coin_coords[1]+410 }}" ] }
                                          - { name: "Point 3", click: [ "{{ expedition_coin_coords[0]+410}}", "{{ expedition_coin_coords[1]+165 }}" ], chest: [ "{{ expedition_coin_coords[0]+300}}", "{{ expedition_coin_coords[1]+215 }}" ] }
                                          - { name: "Point 4", click: [ "{{ expedition_coin_coords[0]+415}}", "{{ expedition_coin_coords[1]+490 }}" ], chest: [ "{{ expedition_coin_coords[0]+300}}", "{{ expedition_coin_coords[1]+415 }}" ] }
                                          - { name: "Point 5", click: [ "{{ expedition_coin_coords[0]+480}}", "{{ expedition_coin_coords[1]+190 }}" ], chest: [ "{{ expedition_coin_coords[0]+300}}", "{{ expedition_coin_coords[1]+175 }}" ] }
                                          - { name: "Point 6", click: [ "{{ expedition_coin_coords[0]+570}}", "{{ expedition_coin_coords[1]+320 }}" ], chest: [ "{{ expedition_coin_coords[0]+300}}", "{{ expedition_coin_coords[1]+255 }}" ] }
                                          - { name: "Point 7", click: [ "{{ expedition_coin_coords[0]+360}}", "{{ expedition_coin_coords[1]+105 }}" ], chest: [ "{{ expedition_coin_coords[0]+300}}", "{{ expedition_coin_coords[1]+90 }}" ] }
                                          - { name: "Point 8", click: [ "{{ expedition_coin_coords[0]+460}}", "{{ expedition_coin_coords[1]+175 }}" ], chest: [ "{{ expedition_coin_coords[0]+435}}", "{{ expedition_coin_coords[1]+140 }}" ] }
                                          - { name: "Point 9", click: [ "{{ expedition_coin_coords[0]+630}}", "{{ expedition_coin_coords[1]+330 }}" ], chest: [ "{{ expedition_coin_coords[0]+735}}", "{{ expedition_coin_coords[1]+380 }}" ] }
                                    - set:
                                        expedition_counter: 0
                                    - while:
                                        condition: "expedition_counter < len(expedition_points_data)"
                                        do:
                                          # Get the data for the current point
                                          - set:
                                              current_point: "{{ expedition_points_data[expedition_counter] }}"
                                          - log: "--- Starting Expedition {{ current_point.name }} ---"

                                          - click: "{{ current_point.click }}"
                                          - delay: 3
                                          - set:
                                              start_button_coords: "{{ get_coords_from_image('start_red.png') }}"
                                          - if:
                                              condition: "start_button_coords"
                                              then:
                                                - click: "{{ start_button_coords }}"
                                                - delay: 3
                                                - set:
                                                    confirm_button_coords: "{{ get_coords_from_image('confirm.png') }}"
                                                - if:
                                                    condition: "confirm_button_coords"
                                                    then:
                                                      - click: "{{ confirm_button_coords }}"
                                                      - delay: 3
                                                      # Use the 'chest' coordinates from our data
                                                      - click: "{{ current_point.chest }}"
                                                      - delay: 3
                                                      - set:
                                                          claim_button_coords: "{{ get_coords_from_image('claim_yellow.png') }}"
                                                      - if:
                                                          condition: "claim_button_coords"
                                                          then:
                                                            - click: "{{ claim_button_coords }}"
                                                            - delay: 3
                                                          else:
                                                            - log: "WARNING: Claim button not found for {{ current_point.name }}."
                                                    else:
                                                      - log: "WARNING: Inner Confirm button not found for {{ current_point.name }}."
                                              else:
                                                - log: "WARNING: Start button not found for {{ current_point.name }}."

                                          # 5. INCREMENT THE COUNTER TO MOVE TO THE NEXT POINT
                                          - increment: expedition_counter
                                  else:
                                    - log: "Confirm button is not available, continuing without it"
                            else:
                              - log: "Expedition1 free refresh button is not available, continuing without it"
                      else: 
                        - log: "Expedition1 icon is not available, continuing without it"
                  - click: [60, 50] # exit Expedition screen
                else:
                  - log: "Expedition1 icon is not available, continuing without it"
                                                            
                                                            
                
          else:
            - log: "Guild icon is not available. I'm trying to restart the game."
            - set:
                game_icon_coords: "{{ get_coords_from_image('clone_evolution.png') }}"
            - if:
                condition: "game_icon_coords"  # This is true if coordinates were found, false
                then:
                  - log: "Game icon coordinates found, clicking on it to restart the game."
                  - click: "{{ game_icon_coords }}" # Click on the Game icon to restart the game
                  - delay: 150 # Wait for the game to restart
                  - log: "Expedition1_farming scenario is skipped due to game unavailability and restarted."
                  - send_email: "[ERROR] Expedition1_farming scenario is skipped for the {{ instance_name }} instance and game was restarted." 
                else:
                  - log: "Game icon coordinates not found, cannot restart the game."
                  - send_email: "[ERROR] Expedition1_farming scenario is skipped for the {{ instance_name }} instance and game was not restarted." 